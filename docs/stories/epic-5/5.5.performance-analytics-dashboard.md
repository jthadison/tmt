# Story 5.5: Performance Analytics Dashboard

## Status
Ready

## Story
**As a** trader,  
**I want** comprehensive analytics,  
**so that** I can optimize my trading strategies.

## Acceptance Criteria
1. Aggregate performance metrics across all accounts
2. Performance comparison charts between accounts
3. Trade analysis by pattern type, time of day, and market session
4. Monthly/weekly/daily performance breakdown
5. Export functionality for reports in PDF and CSV formats
6. Custom date range selection for all analytics

## Tasks / Subtasks

- [ ] Task 1: Create aggregate performance metrics display (AC: 1)
  - [ ] Calculate and display total P&L across all accounts
  - [ ] Show aggregate win rate and profit factor
  - [ ] Display combined Sharpe ratio and risk metrics
  - [ ] Implement portfolio-level drawdown analysis
  - [ ] Add performance comparison vs benchmarks
  
- [ ] Task 2: Build account performance comparison system (AC: 2)
  - [ ] Create side-by-side account comparison charts
  - [ ] Implement normalized performance visualization
  - [ ] Add performance ranking and sorting
  - [ ] Build correlation analysis between accounts
  - [ ] Create account performance heatmap
  
- [ ] Task 3: Develop trade analysis dashboard (AC: 3)
  - [ ] Create trade breakdown by pattern type
  - [ ] Build time-of-day performance analysis
  - [ ] Implement market session performance tracking
  - [ ] Add symbol/currency pair performance breakdown
  - [ ] Create pattern success rate visualization
  
- [ ] Task 4: Implement time-based performance breakdown (AC: 4)
  - [ ] Create monthly performance calendar view
  - [ ] Build weekly performance trend analysis
  - [ ] Implement daily performance statistics
  - [ ] Add seasonal performance patterns
  - [ ] Create performance streak tracking
  
- [ ] Task 5: Build report export functionality (AC: 5)
  - [ ] Implement PDF report generation
  - [ ] Create CSV data export options
  - [ ] Build custom report templates
  - [ ] Add automated report scheduling
  - [ ] Include chart and table export options
  
- [ ] Task 6: Create date range selection system (AC: 6)
  - [ ] Build custom date range picker component
  - [ ] Implement preset date ranges (1M, 3M, 6M, 1Y)
  - [ ] Add date range validation and limits
  - [ ] Create date range persistence across sessions
  - [ ] Implement efficient date-based data filtering

## Dev Notes

### Architecture Context
This story creates a comprehensive analytics dashboard that provides traders with deep insights into their trading performance across all accounts. It serves as the primary tool for strategy optimization and performance analysis, enabling data-driven decision making.

### Data Models
[Source: docs/architecture/data-models.md]
```typescript
interface PerformanceMetrics {
  totalPnL: number;
  totalTrades: number;
  winRate: number;
  profitFactor: number;
  sharpeRatio: number;
  maxDrawdown: number;
  averageWin: number;
  averageLoss: number;
  bestTrade: number;
  worstTrade: number;
  longestWinStreak: number;
  longestLossStreak: number;
}

interface TradeAnalysis {
  byPattern: Record<string, {
    count: number;
    winRate: number;
    avgPnL: number;
    totalPnL: number;
  }>;
  byTimeOfDay: Record<number, PerformanceMetrics>; // hour 0-23
  byMarketSession: Record<'asian' | 'london' | 'newyork', PerformanceMetrics>;
  bySymbol: Record<string, PerformanceMetrics>;
  byDayOfWeek: Record<number, PerformanceMetrics>; // 0-6
}

interface PerformanceReport {
  id: string;
  accountIds: string[];
  dateRange: {
    start: Date;
    end: Date;
  };
  aggregateMetrics: PerformanceMetrics;
  accountComparisons: AccountPerformanceComparison[];
  tradeAnalysis: TradeAnalysis;
  timeBreakdown: TimePerformanceBreakdown;
  generatedAt: Date;
  reportType: 'standard' | 'detailed' | 'executive';
}

interface AccountPerformanceComparison {
  accountId: string;
  accountName: string;
  metrics: PerformanceMetrics;
  rank: number;
  correlationToPortfolio: number;
}

interface TimePerformanceBreakdown {
  monthly: Record<string, PerformanceMetrics>; // YYYY-MM format
  weekly: Record<string, PerformanceMetrics>;  // ISO week format
  daily: Record<string, PerformanceMetrics>;   // YYYY-MM-DD format
}
```

### Component Architecture
[Source: docs/architecture/frontend-architecture.md]
```
components/
├── analytics/
│   ├── AnalyticsDashboard.tsx       # Main container
│   ├── AggregateMetrics.tsx        # Portfolio-wide metrics
│   ├── AccountComparison.tsx       # Account comparison charts
│   ├── TradeAnalysis.tsx           # Pattern and timing analysis
│   ├── TimeBreakdown.tsx           # Time-based performance
│   ├── ReportExporter.tsx          # Export functionality
│   ├── DateRangePicker.tsx         # Date selection
│   └── PerformanceCharts.tsx       # Reusable chart components
```

### Chart and Visualization Libraries
[Source: docs/architecture/frontend-architecture.md]
- **Primary Charting**: Chart.js with react-chartjs-2
- **Advanced Visualizations**: D3.js for custom heatmaps and complex charts
- **Performance Tables**: TanStack Table for data grids
- **Date Pickers**: React DatePicker with custom styling
- **Export Charts**: html2canvas for chart image generation

### API Integration
[Source: docs/architecture/rest-api-spec.md]
- `GET /api/analytics/aggregate` - Aggregate performance metrics
- `GET /api/analytics/accounts/compare` - Account comparison data
- `GET /api/analytics/trades/analysis` - Trade pattern analysis
- `GET /api/analytics/performance/breakdown` - Time-based breakdown
- `POST /api/analytics/reports/generate` - Generate custom reports
- `GET /api/analytics/reports/{id}/download` - Download reports
- `GET /api/analytics/data/export` - Export raw data

### Performance Optimization
[Source: docs/architecture/frontend-architecture.md]
- **Data Aggregation**: Server-side pre-aggregation for common queries
- **Caching Strategy**: Redis caching for expensive calculations
- **Lazy Loading**: Load chart data only when tabs are activated
- **Virtual Scrolling**: For large trade datasets in tables
- **Chart Optimization**: Canvas rendering for performance-critical charts

### Report Generation
[Source: docs/architecture/backend-architecture.md]
- **PDF Generation**: Puppeteer for high-quality PDF reports
- **CSV Export**: Streaming CSV generation for large datasets
- **Template System**: Customizable report templates
- **Async Processing**: Background job processing for large reports
- **File Storage**: S3-compatible storage for generated reports

### Date Range Handling
- **Default Ranges**: Last 30 days, 90 days, 6 months, 1 year, YTD
- **Custom Ranges**: Calendar-based selection with validation
- **Time Zone Handling**: UTC storage with local display
- **Performance Limits**: Maximum 2-year range for detailed analysis
- **Data Availability**: Handle accounts with different start dates

### Calculation Accuracy
[Source: docs/architecture/data-models.md]
- **Decimal Precision**: Use Decimal.js for financial calculations
- **Time-Weighted Returns**: Account for deposits/withdrawals
- **Risk-Free Rate**: Configurable rate for Sharpe ratio calculations
- **Benchmark Comparisons**: Configurable benchmark indices
- **Currency Normalization**: Handle multi-currency accounts

### Testing Standards
- Test aggregate calculations with multiple accounts
- Verify chart rendering with different data scenarios
- Test export functionality for various report types
- Validate date range filtering and performance
- Test responsive behavior for analytics components

## Testing

### Test Requirements
[Source: docs/architecture/testing-strategy.md]
- **Unit Tests**: Calculation accuracy, component rendering, data formatting
- **Integration Tests**: API integration, chart interactions, export functionality
- **E2E Tests**: Complete analytics workflow, report generation
- **Performance Tests**: Large dataset handling, chart rendering performance
- **Visual Tests**: Chart accuracy and responsive behavior
- **Location**: `dashboard/__tests__/components/analytics/`

### Specific Testing Focus
- Performance metric calculation accuracy
- Chart rendering with various data sizes
- Account comparison logic and visualization
- Date range filtering performance
- Export functionality for PDF and CSV formats
- Responsive behavior across device sizes

### Mock Data Requirements
- Historical performance data for multiple accounts
- Trade data with various patterns and timing
- Account data with different performance characteristics
- Time-series data for different date ranges
- Large datasets for performance testing (1000+ trades)

### Calculation Testing
- Verify Sharpe ratio calculations with known datasets
- Test win rate and profit factor accuracy
- Validate drawdown calculations
- Test time-weighted return calculations
- Verify correlation analysis between accounts

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation.*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation.*