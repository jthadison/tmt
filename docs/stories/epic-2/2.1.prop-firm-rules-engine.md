# Story 2.1: Prop Firm Rules Engine

## Status
Draft

## Story
**As a** funded trader,
**I want** automatic validation of trades against prop firm rules,
**so that** I never violate terms that could lose my account.

## Acceptance Criteria
1. Rule configurations for DNA Funded, Funding Pips, and The Funded Trader implemented
2. Pre-trade validation checks: daily loss limit, max loss limit, position size limits
3. Real-time tracking of daily and total P&L against limits
4. News trading restrictions enforced based on economic calendar
5. Minimum holding time requirements validated before closing positions
6. Rule violations logged with detailed explanation and prevented trades

## Tasks / Subtasks
- [ ] Task 1: Create Compliance Agent service structure (AC: 1)
  - [ ] Create `/agents/compliance/` directory with Python FastAPI structure
  - [ ] Implement base compliance agent class inheriting from shared BaseAgent
  - [ ] Create rules_engine.py for prop firm rule validation
  - [ ] Implement prop_firm_configs.py with DNA Funded, Funding Pips, The Funded Trader rules
  - [ ] Configure agent to consume Kafka events for trade validation
- [ ] Task 2: Implement prop firm rule configurations (AC: 1)
  - [ ] Define DNA Funded rules: 5% daily loss, 10% max loss, consistency requirements
  - [ ] Define Funding Pips rules: 4% daily loss, 8% max loss, profit target requirements
  - [ ] Define The Funded Trader rules: 5% daily loss, 10% max loss, scaling plan rules
  - [ ] Create rule configuration loader with JSON/YAML support
  - [ ] Implement rule versioning for updates and changes
- [ ] Task 3: Build pre-trade validation system (AC: 2)
  - [ ] Implement daily loss limit validator against current P&L
  - [ ] Implement max loss limit validator against account equity
  - [ ] Create position size validator based on account balance and rules
  - [ ] Add margin requirement checker for sufficient funds
  - [ ] Implement trade rejection with detailed reason codes
- [ ] Task 4: Develop real-time P&L tracking (AC: 3)
  - [ ] Create P&L calculator for open and closed positions
  - [ ] Implement daily P&L reset at market close/midnight
  - [ ] Track running total drawdown from initial balance
  - [ ] Configure real-time updates via WebSocket for dashboard
  - [ ] Add P&L persistence to database for recovery
- [ ] Task 5: Implement news trading restrictions (AC: 4)
  - [ ] Integrate economic calendar API for news events
  - [ ] Create news event severity classifier (high/medium/low impact)
  - [ ] Implement time-based trading blocks around news events
  - [ ] Add configurable buffer times before/after news per prop firm
  - [ ] Create override mechanism for non-news affected pairs
- [ ] Task 6: Add holding time validation (AC: 5)
  - [ ] Track position open times for all trades
  - [ ] Implement minimum hold time checker before position close
  - [ ] Create prop firm specific hold time configurations
  - [ ] Add warning system for approaching minimum hold times
  - [ ] Implement force-hold mechanism to prevent early closes
- [ ] Task 7: Create violation logging and prevention (AC: 6)
  - [ ] Design violation log schema with timestamps and details
  - [ ] Implement trade blocking when violations detected
  - [ ] Create detailed violation reason messages for user feedback
  - [ ] Add violation metrics for monitoring and analysis
  - [ ] Configure alerts for critical violations

## Dev Notes

### Architecture Context
The Compliance Agent is responsible for ensuring all trades comply with prop firm rules to maintain account funding and prevent violations that could lead to account termination. This agent must validate every trade before execution and continuously monitor account state against firm-specific rules. The system targets 99.8% compliance rates as specified in the PRD. [Source: architecture/high-level-architecture.md#technical-summary]

### Previous Epic Context
Epic 1 established the foundation with Circuit Breaker Agent for emergency stops, Kafka messaging for inter-agent communication, and monitoring infrastructure. The Compliance Agent builds on this foundation, integrating with the Circuit Breaker for rule-based trading halts and using Kafka events for real-time trade validation.

### Data Models and Schema
The compliance system uses the following database schema:
```sql
trading_accounts:
- prop_firm VARCHAR(50) - FTMO, MyForexFunds, FundedNext
- max_daily_loss DECIMAL(12,2) - Daily loss limit
- max_total_loss DECIMAL(12,2) - Maximum allowed drawdown
- current_daily_pnl DECIMAL(12,2) - Running daily P&L
- status VARCHAR(20) - active, suspended, in_drawdown, terminated
```
[Source: architecture/database-schema.md#trading-accounts]

### Prop Firm Rule Specifications
Based on industry standards and PRD requirements:

**FTMO Rules:**
- Daily loss limit: 5% of initial balance
- Max loss limit: 10% of initial balance
- News trading: Blocked 2 min before and after high-impact news
- No minimum holding time requirement
- Weekend holding allowed

**FundedNext Rules:**
- Daily loss limit: 4% of initial balance
- Max loss limit: 8% of initial balance
- Minimum holding time: 2 minutes for all positions
- News trading: Blocked 5 min before and after high-impact news

**MyForexFunds Rules:**
- Daily loss limit: 5% of initial balance
- Max loss limit: 12% of initial balance
- Position size limit: Max 0.5 lots per $1000 balance
- News trading restrictions apply to major pairs only

### Integration with Trading Flow
The Compliance Agent integrates into the trading workflow:
1. Market Analysis Agent generates signal → Compliance validates rules
2. Risk Management calculates position → Compliance checks size limits
3. Before execution → Compliance final validation
4. During position hold → Compliance monitors holding time
5. Before close → Compliance validates minimum hold time met

### Event Integration
Kafka events for compliance monitoring:
- **Consume:** `trading.signals.generated` for pre-trade validation
- **Consume:** `execution.order.placed` for position tracking
- **Publish:** `compliance.validation.passed` for approved trades
- **Publish:** `compliance.violation.detected` for rule violations
- **Publish:** `compliance.account.suspended` for critical violations

### API Endpoints
The Compliance Agent exposes:
- **GET /api/v1/compliance/validate-trade** - Pre-trade validation
- **GET /api/v1/compliance/account-status/{account_id}** - Current compliance state
- **GET /api/v1/compliance/violations/{account_id}** - Violation history
- **POST /api/v1/compliance/update-rules** - Update prop firm rules
- **GET /api/v1/compliance/pnl/{account_id}** - Real-time P&L status

### Economic Calendar Integration
News trading restrictions require external data:
- **Primary source:** ForexFactory or Investing.com economic calendar API
- **Update frequency:** Every 5 minutes for upcoming events
- **Event classification:** High (NFP, FOMC), Medium (GDP, CPI), Low (minor indicators)
- **Time windows:** Configurable per prop firm (typically 2-5 min before/after)

[Source: architecture/external-apis.md]

### Real-time P&L Calculation
P&L tracking implementation requirements:
- **Update frequency:** Every tick for open positions
- **Daily reset:** Configurable time per prop firm (usually midnight broker time)
- **Calculation method:** Unrealized P&L = (Current Price - Entry Price) × Position Size × Pip Value
- **Persistence:** Store snapshots every minute for recovery
- **Precision:** Use Decimal type for all monetary calculations

### Violation Prevention Strategy
Multi-layer validation approach:
1. **Pre-trade validation:** Check all rules before order submission
2. **Real-time monitoring:** Continuous P&L and drawdown tracking
3. **Circuit breaker integration:** Trigger emergency stop on critical violations
4. **Grace periods:** Warning zones at 80% of limits
5. **Auto-recovery:** Resume trading when conditions normalize

### Testing Requirements
- **Unit tests:** Each rule validator with edge cases
- **Integration tests:** Full trade validation flow with multiple prop firms
- **Compliance tests:** Verify 99.8% accuracy target
- **Performance tests:** Validation must complete within 50ms
- **Scenario tests:** News events, drawdown recovery, multiple violations

[Source: architecture/test-strategy-and-standards.md]

### Error Handling
Compliance-specific error handling:
- **PropFirmRuleViolation:** Base exception for all rule violations
- **DailyLossExceeded:** Daily limit reached
- **MaxDrawdownExceeded:** Account max loss reached
- **NewsBlackoutViolation:** Trading during restricted news period
- **MinimumHoldTimeViolation:** Position closed too early

All errors must include account_id, rule violated, current values, and limits.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-06 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*