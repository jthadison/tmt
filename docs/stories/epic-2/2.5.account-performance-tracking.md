# Story 2.5: Account Performance Tracking

## Status
Draft

## Story
**As a** trader,
**I want** to see individual and aggregate performance metrics,
**so that** I can optimize my account allocation and strategies.

## Acceptance Criteria
1. Real-time P&L tracking per account and aggregate
2. Performance metrics: win rate, profit factor, Sharpe ratio, maximum drawdown
3. Daily, weekly, monthly performance reports per account
4. Comparison view between accounts highlighting best/worst performers
5. Export capability for tax reporting and prop firm verification
6. Performance data retained for 2 years minimum

## Tasks / Subtasks
- [ ] Task 1: Implement real-time P&L tracking system (AC: 1)
  - [ ] Create P&L calculation engine for open and closed positions
  - [ ] Implement real-time updates via market data feeds
  - [ ] Calculate unrealized P&L for open positions
  - [ ] Track realized P&L for closed trades
  - [ ] Aggregate P&L across all accounts
  - [ ] Add WebSocket streaming for dashboard updates
- [ ] Task 2: Build performance metrics calculator (AC: 2)
  - [ ] Implement win rate calculation (winning trades / total trades)
  - [ ] Calculate profit factor (gross profit / gross loss)
  - [ ] Implement Sharpe ratio with configurable risk-free rate
  - [ ] Calculate maximum drawdown (peak to trough)
  - [ ] Add Sortino ratio for downside risk assessment
  - [ ] Implement Calmar ratio (annual return / max drawdown)
- [ ] Task 3: Create periodic performance reports (AC: 3)
  - [ ] Design daily performance summary generator
  - [ ] Implement weekly performance aggregation
  - [ ] Create monthly detailed performance reports
  - [ ] Add year-to-date and annual summaries
  - [ ] Include trade distribution analysis
  - [ ] Generate performance attribution reports
- [ ] Task 4: Build account comparison system (AC: 4)
  - [ ] Create performance ranking algorithm
  - [ ] Implement best/worst performer identification
  - [ ] Add performance heatmap visualization
  - [ ] Create relative performance metrics
  - [ ] Build performance trend comparison
  - [ ] Add anomaly detection for unusual performance
- [ ] Task 5: Implement export functionality (AC: 5)
  - [ ] Create CSV export for spreadsheet analysis
  - [ ] Generate PDF reports for prop firm submission
  - [ ] Implement tax reporting format (Form 8949/Schedule D)
  - [ ] Add API export for third-party tools
  - [ ] Create customizable export templates
  - [ ] Implement scheduled automated exports
- [ ] Task 6: Setup data retention system (AC: 6)
  - [ ] Design performance data schema with partitioning
  - [ ] Implement 2-year retention policy
  - [ ] Create data archival system for older records
  - [ ] Add data compression for storage efficiency
  - [ ] Implement data recovery procedures
  - [ ] Create performance data backup strategy

## Dev Notes

### Architecture Context
The Account Performance Tracking system provides comprehensive analytics and reporting capabilities for monitoring trading performance across multiple prop firm accounts. This system enables traders to optimize strategies, meet prop firm reporting requirements, and maintain tax compliance. The system must handle high-frequency updates while maintaining historical accuracy for long-term analysis.

### Previous Story Context
Stories 2.1-2.4 established compliance, multi-account management, legal separation, and anti-correlation systems. The Performance Tracking system integrates with all these components to provide unified performance visibility while maintaining account separation and compliance requirements.

### Performance Metrics Calculations
Detailed implementation of key metrics:

**Win Rate:**
```python
def calculate_win_rate(trades):
    """Win Rate = Profitable Trades / Total Trades"""
    profitable_trades = len([t for t in trades if t.pnl > 0])
    total_trades = len(trades)
    return (profitable_trades / total_trades) * 100 if total_trades > 0 else 0
```

**Profit Factor:**
```python
def calculate_profit_factor(trades):
    """Profit Factor = Gross Profit / Gross Loss"""
    gross_profit = sum([t.pnl for t in trades if t.pnl > 0])
    gross_loss = abs(sum([t.pnl for t in trades if t.pnl < 0]))
    return gross_profit / gross_loss if gross_loss > 0 else float('inf')
```

**Sharpe Ratio:**
```python
def calculate_sharpe_ratio(returns, risk_free_rate=0.02):
    """Sharpe = (Mean Return - Risk Free Rate) / Std Dev of Returns"""
    excess_returns = returns - risk_free_rate
    return np.mean(excess_returns) / np.std(excess_returns) * np.sqrt(252)
```

**Maximum Drawdown:**
```python
def calculate_max_drawdown(equity_curve):
    """Max Drawdown = Maximum peak to trough decline"""
    running_max = np.maximum.accumulate(equity_curve)
    drawdown = (equity_curve - running_max) / running_max
    return np.min(drawdown) * 100
```

### Performance Database Schema
Comprehensive schema for performance tracking:
```sql
CREATE TABLE trade_performance (
    trade_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    account_id UUID NOT NULL REFERENCES trading_accounts(account_id),
    symbol VARCHAR(20) NOT NULL,
    entry_time TIMESTAMP WITH TIME ZONE NOT NULL,
    exit_time TIMESTAMP WITH TIME ZONE,
    entry_price DECIMAL(10,5) NOT NULL,
    exit_price DECIMAL(10,5),
    position_size DECIMAL(10,4) NOT NULL,
    pnl DECIMAL(12,2),
    pnl_percentage DECIMAL(8,4),
    commission DECIMAL(8,2),
    swap DECIMAL(8,2),
    trade_duration_seconds INTEGER,
    
    INDEX idx_performance_account (account_id),
    INDEX idx_performance_time (entry_time)
);

CREATE TABLE performance_metrics (
    metric_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    account_id UUID NOT NULL REFERENCES trading_accounts(account_id),
    period_type VARCHAR(20) NOT NULL, -- daily, weekly, monthly
    period_start TIMESTAMP WITH TIME ZONE NOT NULL,
    period_end TIMESTAMP WITH TIME ZONE NOT NULL,
    total_trades INTEGER NOT NULL DEFAULT 0,
    winning_trades INTEGER NOT NULL DEFAULT 0,
    losing_trades INTEGER NOT NULL DEFAULT 0,
    win_rate DECIMAL(5,2),
    profit_factor DECIMAL(8,2),
    sharpe_ratio DECIMAL(8,4),
    sortino_ratio DECIMAL(8,4),
    max_drawdown DECIMAL(8,4),
    total_pnl DECIMAL(12,2),
    average_win DECIMAL(10,2),
    average_loss DECIMAL(10,2),
    largest_win DECIMAL(10,2),
    largest_loss DECIMAL(10,2),
    
    UNIQUE(account_id, period_type, period_start)
);

CREATE TABLE performance_snapshots (
    snapshot_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    account_id UUID NOT NULL REFERENCES trading_accounts(account_id),
    snapshot_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    balance DECIMAL(12,2) NOT NULL,
    equity DECIMAL(12,2) NOT NULL,
    margin_used DECIMAL(12,2),
    free_margin DECIMAL(12,2),
    open_positions INTEGER,
    daily_pnl DECIMAL(10,2),
    weekly_pnl DECIMAL(10,2),
    monthly_pnl DECIMAL(10,2),
    
    INDEX idx_snapshot_account_time (account_id, snapshot_time)
);
```

### Real-time P&L Tracking Architecture
System design for real-time updates:
```python
class PnLTracker:
    def __init__(self):
        self.positions = {}  # account_id -> [positions]
        self.market_data = MarketDataFeed()
        self.websocket_server = WebSocketServer()
        
    async def update_pnl(self):
        """Update P&L on each market tick"""
        while True:
            tick = await self.market_data.get_tick()
            
            for account_id, positions in self.positions.items():
                account_pnl = self.calculate_account_pnl(positions, tick)
                
                # Update database
                await self.store_pnl_snapshot(account_id, account_pnl)
                
                # Stream to dashboard
                await self.websocket_server.broadcast({
                    'account_id': account_id,
                    'pnl': account_pnl,
                    'timestamp': tick.timestamp
                })
```

### Report Generation Templates
Performance report structures:

**Daily Report:**
- Opening balance and equity
- Total trades executed
- Winning/losing trade breakdown  
- P&L for the day
- Key metrics (win rate, profit factor)
- Best and worst trades
- Risk metrics (drawdown, exposure)

**Monthly Report:**
- Monthly P&L summary
- Performance metrics comparison
- Trade distribution analysis
- Strategy performance breakdown
- Risk-adjusted returns
- Compliance violations (if any)
- Correlation analysis

### Export Formats
Multiple export options for different purposes:

**Tax Reporting (IRS Form 8949):**
```csv
Description,Date Acquired,Date Sold,Proceeds,Cost Basis,Gain/Loss
EUR/USD 0.1 lots,01/01/2024,01/02/2024,1250.00,1200.00,50.00
```

**Prop Firm Verification:**
```json
{
  "account_number": "12345",
  "period": "2024-01",
  "starting_balance": 100000,
  "ending_balance": 102500,
  "total_return": 2.5,
  "max_drawdown": 3.2,
  "total_trades": 145,
  "win_rate": 58.6,
  "profit_factor": 1.85
}
```

### Account Comparison Algorithms
Methods for comparing account performance:

1. **Ranking Algorithm:**
   - Multi-factor scoring (return, risk, consistency)
   - Weighted performance metrics
   - Time-adjusted comparisons

2. **Relative Performance:**
   - Performance vs account average
   - Percentile rankings
   - Z-score calculations

3. **Attribution Analysis:**
   - Performance by strategy
   - Performance by instrument
   - Performance by time period

### Data Retention Strategy
Long-term storage approach:
- **Hot Storage (0-3 months):** Real-time database for active queries
- **Warm Storage (3-12 months):** Indexed archive for reports
- **Cold Storage (1-2 years):** Compressed archive for compliance
- **Purge (>2 years):** Automated deletion with audit log

### API Endpoints
Performance tracking endpoints:
- **GET /api/v1/performance/pnl/{account_id}** - Real-time P&L
- **GET /api/v1/performance/metrics/{account_id}** - Performance metrics
- **GET /api/v1/performance/report/{period}** - Periodic reports
- **GET /api/v1/performance/compare** - Account comparison
- **POST /api/v1/performance/export** - Generate exports
- **GET /api/v1/performance/history/{account_id}** - Historical data

### WebSocket Streams
Real-time performance updates:
```javascript
// Subscribe to performance updates
ws.send({
  "action": "subscribe",
  "channels": ["performance", "pnl", "metrics"],
  "accounts": ["account1", "account2"]
});

// Receive updates
{
  "channel": "pnl",
  "data": {
    "account_id": "account1",
    "realized_pnl": 250.50,
    "unrealized_pnl": 125.75,
    "total_pnl": 376.25,
    "daily_change": 2.5,
    "timestamp": "2024-01-01T10:00:00Z"
  }
}
```

### Testing Requirements
- **Calculation tests:** Verify metric accuracy with known datasets
- **Performance tests:** Handle 1000+ trades per account
- **Real-time tests:** Validate <100ms P&L update latency
- **Report tests:** Ensure report accuracy and completeness
- **Export tests:** Validate all export formats
- **Retention tests:** Verify 2-year data retention
- **Integration tests:** Test with all account management systems

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-06 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*