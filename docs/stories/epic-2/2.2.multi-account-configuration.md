# Story 2.2: Multi-Account Configuration Management

## Status
Draft

## Story
**As a** trader managing multiple accounts,
**I want** to configure each account with its specific broker and rules,
**so that** I can trade appropriately across different prop firms.

## Acceptance Criteria
1. Account configuration API supports adding/editing/removing accounts
2. Each account stores: broker credentials, prop firm rules, risk limits, trading pairs
3. Account credentials encrypted using HashiCorp Vault
4. Configuration changes require 2FA confirmation
5. Account status tracking: active, suspended, in-drawdown, terminated
6. Bulk configuration import/export for backup and migration

## Tasks / Subtasks
- [ ] Task 1: Create account management API endpoints (AC: 1)
  - [ ] Implement POST /api/v1/accounts for account creation
  - [ ] Implement PUT /api/v1/accounts/{id} for account updates
  - [ ] Implement DELETE /api/v1/accounts/{id} for account removal
  - [ ] Implement GET /api/v1/accounts for listing all accounts
  - [ ] Add request validation and error handling
  - [ ] Create account configuration data transfer objects (DTOs)
- [ ] Task 2: Design comprehensive account data model (AC: 2)
  - [ ] Define account configuration schema with all required fields
  - [ ] Implement broker credential storage structure
  - [ ] Create prop firm rule configuration per account
  - [ ] Add risk limit parameters (position size, leverage, pairs)
  - [ ] Store allowed trading pairs and timeframes per account
  - [ ] Add MetaTrader connection parameters (server, port)
- [ ] Task 3: Implement HashiCorp Vault integration (AC: 3)
  - [ ] Configure Vault client with authentication
  - [ ] Create encryption/decryption service for credentials
  - [ ] Implement secure storage paths for each account
  - [ ] Add credential rotation capability
  - [ ] Create audit logging for credential access
  - [ ] Implement emergency credential purge mechanism
- [ ] Task 4: Add 2FA for configuration changes (AC: 4)
  - [ ] Implement TOTP-based 2FA system
  - [ ] Create 2FA setup and QR code generation endpoints
  - [ ] Add 2FA verification for sensitive operations
  - [ ] Implement backup codes for account recovery
  - [ ] Add rate limiting for failed 2FA attempts
  - [ ] Create audit trail for all configuration changes
- [ ] Task 5: Implement account status management (AC: 5)
  - [ ] Create status transition state machine
  - [ ] Implement automatic status updates based on conditions
  - [ ] Add manual status override with authorization
  - [ ] Create status change event notifications
  - [ ] Implement status-based trading restrictions
  - [ ] Add status history tracking with timestamps
- [ ] Task 6: Build import/export functionality (AC: 6)
  - [ ] Create JSON/YAML export format for configurations
  - [ ] Implement bulk account import with validation
  - [ ] Add configuration backup scheduling
  - [ ] Create configuration versioning system
  - [ ] Implement rollback capability for configurations
  - [ ] Add configuration migration tools for updates

## Dev Notes

### Architecture Context
The Multi-Account Configuration Management system is critical for managing multiple prop firm accounts with different rules, credentials, and trading parameters. This system must securely store sensitive broker credentials using HashiCorp Vault while providing flexible configuration management for traders operating across multiple firms. The system supports the PRD goal of managing 10+ accounts simultaneously.

### Previous Story Context
Story 2.1 established the Prop Firm Rules Engine with specific rule configurations for FTMO, FundedNext, and MyForexFunds. This story builds on that foundation by providing the account management layer that associates each account with its specific prop firm rules and trading parameters.

### Data Model Requirements
Based on the database schema, the account configuration includes:
```sql
trading_accounts:
- account_id UUID PRIMARY KEY
- prop_firm VARCHAR(50) - Links to prop firm rules
- account_number VARCHAR(100) - Broker account identifier
- legal_entity_id UUID - For compliance separation
- personality_profile_id UUID - For anti-detection variance
- status VARCHAR(20) - active, suspended, in_drawdown, terminated
- balance DECIMAL(12,2) - Current account balance
- equity DECIMAL(12,2) - Current account equity
- max_daily_loss DECIMAL(12,2) - Daily loss limit
- max_total_loss DECIMAL(12,2) - Maximum drawdown allowed
- encrypted_credentials TEXT - Vault-encrypted broker credentials
```
[Source: architecture/database-schema.md#trading-accounts]

### HashiCorp Vault Integration
Credential security implementation using Vault 1.15.6:
- **Storage path:** `/secret/trading-accounts/{account_id}/credentials`
- **Encryption:** AES-256-GCM with automatic key rotation
- **Access control:** Service account with minimal permissions
- **Audit logging:** All credential access logged with correlation IDs
- **Emergency procedures:** Break-glass access for critical situations

[Source: architecture/tech-stack.md#secrets-management]

### Account Configuration Schema
Comprehensive configuration structure:
```json
{
  "account_id": "uuid",
  "prop_firm": "FTMO|FundedNext|MyForexFunds",
  "broker_credentials": {
    "broker": "MetaTrader4|MetaTrader5",
    "server": "server.broker.com:443",
    "login": "encrypted_login",
    "password": "vault_reference",
    "investor_password": "vault_reference"
  },
  "trading_parameters": {
    "allowed_pairs": ["EURUSD", "GBPUSD", "USDJPY"],
    "max_positions": 3,
    "max_lot_size": 0.5,
    "allowed_timeframes": ["M5", "M15", "H1"],
    "trading_hours": "00:00-23:59",
    "weekend_trading": false
  },
  "risk_limits": {
    "max_daily_loss_percent": 5.0,
    "max_total_loss_percent": 10.0,
    "max_position_size_percent": 2.0,
    "max_correlation": 0.7,
    "require_stop_loss": true
  },
  "personality_profile": "conservative_scalper",
  "legal_entity_id": "uuid",
  "notification_settings": {
    "email": "encrypted_email",
    "webhook_url": "encrypted_url",
    "alert_on_violation": true
  }
}
```

### 2FA Implementation
Security requirements for configuration changes:
- **Method:** Time-based One-Time Password (TOTP) RFC 6238
- **Library:** Python: pyotp for TOTP generation/validation
- **QR Code:** Generate using qrcode library for authenticator apps
- **Backup codes:** Generate 10 single-use recovery codes
- **Session management:** 2FA verification valid for 15 minutes
- **Required for:** Account creation, credential updates, deletion

### Status Management State Machine
Account status transitions and rules:
```
active → suspended: Manual action or minor violation
active → in_drawdown: Daily/total loss threshold reached
suspended → active: Manual reactivation after review
in_drawdown → active: Next trading day or equity restored
any → terminated: Critical violation or manual termination
terminated → [none]: No recovery, requires new account
```

Status-based restrictions:
- **active:** Full trading allowed
- **suspended:** Read-only, no new positions
- **in_drawdown:** Close-only mode
- **terminated:** No access, credentials purged

### Import/Export Format
Configuration backup and migration format:
```yaml
version: "1.0"
export_date: "2024-01-01T00:00:00Z"
accounts:
  - account_id: "uuid"
    prop_firm: "FTMO"
    configuration: {...}
    risk_limits: {...}
    trading_parameters: {...}
metadata:
  total_accounts: 5
  export_reason: "backup|migration"
  encrypted_fields: ["credentials", "personal_data"]
```

### API Security Considerations
- **Authentication:** JWT tokens with account-specific claims
- **Authorization:** Role-based access control (trader, admin, viewer)
- **Rate limiting:** 100 requests per minute per account
- **Input validation:** Strict schema validation for all inputs
- **Audit logging:** Every configuration change logged with user/timestamp

### Integration Points
The configuration management system integrates with:
- **Compliance Agent:** Provides prop firm rules per account
- **Personality Engine:** Links personality profiles to accounts
- **Execution Engine:** Supplies broker credentials and parameters
- **Circuit Breaker:** Status updates trigger trading halts
- **Dashboard:** Real-time account status and configuration UI

### WebSocket Events
Real-time configuration updates:
- `account.created` - New account added
- `account.updated` - Configuration changed
- `account.status.changed` - Status transition occurred
- `account.deleted` - Account removed
- `credentials.rotated` - Credentials updated

### Testing Requirements
- **Security tests:** Vault integration, encryption, 2FA flow
- **API tests:** CRUD operations, validation, error handling
- **Status tests:** All state transitions and restrictions
- **Import/export tests:** Data integrity, format validation
- **Performance tests:** Handle 100+ accounts efficiently
- **Integration tests:** Verify all agent interactions

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-06 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*