# Story 2.1a: Funding Pips Compliance Implementation

## Status
In Progress - PRIORITY 1

## Story
**As a** funded trader using Funding Pips,
**I want** automatic enforcement of all Funding Pips rules,
**so that** I maintain compliance and protect my funded account.

## Acceptance Criteria
1. All Funding Pips rules implemented and enforced in real-time
2. 4% daily loss limit tracked and enforced with warnings at 3.2% (80%)
3. 8% maximum drawdown (static) monitored continuously
4. Mandatory stop-loss automatically added to all trades
5. Weekend position closure automated before market close Friday
6. Minimum 1-minute hold time enforced before allowing position closure
7. Dashboard displays real-time compliance status
8. Integration with TradeLocker platform completed

## Tasks / Subtasks
- [ ] Task 1: Implement Funding Pips rule configuration (AC: 1)
  - [ ] Create funding_pips_config.json with all rule parameters
  - [ ] Define rule priority and enforcement order
  - [ ] Implement rule versioning for updates
  - [ ] Add feature flags for rule testing
  - [ ] Create rule validation unit tests

- [ ] Task 2: Build daily loss limit tracker (AC: 2)
  - [ ] Implement real-time P&L calculation
  - [ ] Create 4% daily limit enforcement
  - [ ] Add warning system at 80%, 90%, 95% thresholds
  - [ ] Implement automatic trade blocking at limit
  - [ ] Add daily reset at market close
  - [ ] Create override mechanism for emergency situations

- [ ] Task 3: Implement static drawdown monitoring (AC: 3)
  - [ ] Calculate drawdown from initial balance (not trailing)
  - [ ] Monitor 8% maximum threshold continuously
  - [ ] Block new trades when approaching limit
  - [ ] Create visual indicators for current drawdown
  - [ ] Add historical drawdown tracking
  - [ ] Implement recovery tracking after drawdown

- [ ] Task 4: Create mandatory stop-loss system (AC: 4)
  - [ ] Auto-calculate stop-loss based on 2% risk rule
  - [ ] Prevent order submission without stop-loss
  - [ ] Add stop-loss to existing positions if missing
  - [ ] Implement stop-loss modification rules
  - [ ] Create alerts for stop-loss triggers
  - [ ] Add stop-loss effectiveness reporting

- [ ] Task 5: Build weekend closure automation (AC: 5)
  - [ ] Schedule position checks for Friday 4:50 PM EST
  - [ ] Implement automatic position closure
  - [ ] Add configurable closure time window
  - [ ] Create manual override with logging
  - [ ] Send notifications before auto-closure
  - [ ] Handle partial fills and pending orders

- [ ] Task 6: Implement minimum hold time (AC: 6)
  - [ ] Track position open timestamps
  - [ ] Block closure attempts before 1 minute
  - [ ] Add countdown timer in UI
  - [ ] Create exemptions for stop-loss hits
  - [ ] Log all early closure attempts
  - [ ] Add hold time statistics tracking

- [ ] Task 7: Create compliance dashboard (AC: 7)
  - [ ] Design real-time compliance status display
  - [ ] Show current drawdown and daily loss
  - [ ] Display time until weekend closure
  - [ ] Add position hold time indicators
  - [ ] Create compliance score calculation
  - [ ] Implement alert notification system

- [ ] Task 8: TradeLocker integration (AC: 8)
  - [ ] Connect compliance engine to TradeLocker events
  - [ ] Implement pre-trade validation via TradeLocker
  - [ ] Add real-time position monitoring
  - [ ] Create TradeLocker-specific error handling
  - [ ] Test with TradeLocker sandbox
  - [ ] Implement failover procedures

## Dev Notes

### Funding Pips Specific Rules
```python
FUNDING_PIPS_RULES = {
    "risk_management": {
        "daily_loss_limit": 0.04,  # 4% of initial balance
        "max_drawdown": 0.08,       # 8% static (not trailing)
        "max_risk_per_trade": 0.02, # 2% for stop-loss calculation
    },
    "position_management": {
        "mandatory_stop_loss": True,
        "min_hold_time_seconds": 60,
        "weekend_closure_required": True,
        "weekend_closure_time": "16:50 EST Friday",
    },
    "trading_restrictions": {
        "news_trading": "allowed_with_monitoring",
        "max_leverage": {
            "forex": 30,
            "indices": 20
        },
        "prohibited_strategies": [
            "copy_trading",
            "tick_scalping", 
            "latency_arbitrage"
        ]
    },
    "account_management": {
        "profit_split": 0.85,  # 85% to trader
        "first_payout_days": 14,
        "payout_frequency": "weekly",
        "min_trading_days": 3,
        "evaluation_profit_target": 0.08  # 8%
    }
}
```

### Integration Points
- **TradeLocker WebSocket:** Real-time position updates
- **TradeLocker REST:** Order placement with stop-loss
- **Compliance Agent:** Rule enforcement coordination
- **Risk Agent:** Position sizing based on 2% rule
- **Dashboard:** Real-time compliance display

### Testing Scenarios
1. **Approach daily loss limit**
   - Test at 3.2% (80% warning)
   - Test at 3.6% (90% warning)
   - Test at 3.8% (95% alert)
   - Test at 4.0% (block trades)

2. **Weekend closure**
   - Test auto-closure at 4:50 PM EST
   - Test with multiple open positions
   - Test with pending orders
   - Test manual override

3. **Stop-loss enforcement**
   - Test order rejection without SL
   - Test automatic SL calculation
   - Test SL modification rules

## Dependencies
- TradeLocker Integration (Story 4.1a) - MUST BE COMPLETE
- Compliance Agent setup (Story 2.1)
- Dashboard real-time updates
- WebSocket connection for monitoring

## Compliance Certification
This implementation will be audited against official Funding Pips rules documentation to ensure 100% compliance. Any discrepancies will be resolved before production deployment.

## Performance Requirements
- Rule validation: <10ms per check
- Dashboard updates: <1 second latency
- Position monitoring: Real-time via WebSocket
- Weekend closure: Execution within 30 seconds

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-07 | 1.0 | Initial Funding Pips priority story | Sarah (PO) |
| 2025-01-07 | 1.1 | Marked as PRIORITY 1 for immediate implementation | Sarah (PO) |