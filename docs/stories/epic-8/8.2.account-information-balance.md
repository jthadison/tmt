# Story 8.2: Account Information & Balance Tracking

## Status
Ready

## Story
**As a** trader,
**I want** to see my OANDA account balance and margin in real-time,
**so that** I can monitor my trading capital and risk exposure.

## Acceptance Criteria
1. Display account balance, unrealized P&L, and realized P&L
2. Show margin used, margin available, and margin closeout percentage
3. List all tradeable instruments with current spreads
4. Update account metrics every 5 seconds or on trade execution
5. Display account currency and leverage settings
6. Show number of open positions and pending orders
7. Calculate account equity (balance + unrealized P&L)
8. Historical balance chart for last 30 days

## Tasks / Subtasks
- [ ] Task 1: Build OANDA account data fetcher (AC: 1, 2, 5, 6, 7)
  - [ ] Create OandaAccountManager class
  - [ ] Implement account summary endpoint integration
  - [ ] Add margin calculation methods
  - [ ] Create P&L aggregation logic
  - [ ] Implement position count tracking
  - [ ] Add account equity calculation

- [ ] Task 2: Implement instrument information service (AC: 3)
  - [ ] Fetch tradeable instruments list
  - [ ] Calculate current spreads for each instrument
  - [ ] Cache instrument data with TTL
  - [ ] Track instrument trading status
  - [ ] Add instrument filtering by type
  - [ ] Create spread history tracking

- [ ] Task 3: Create real-time update system (AC: 4)
  - [ ] Set up 5-second polling interval
  - [ ] Implement trade execution triggers
  - [ ] Create WebSocket updates for UI
  - [ ] Add update batching for efficiency
  - [ ] Implement change detection logic
  - [ ] Create update failure handling

- [ ] Task 4: Build historical data service (AC: 8)
  - [ ] Implement 30-day balance history fetch
  - [ ] Create time-series data storage
  - [ ] Add data aggregation by day
  - [ ] Implement chart data formatting
  - [ ] Create balance trend analysis
  - [ ] Add export functionality

- [ ] Task 5: Create dashboard components (AC: 1-8)
  - [ ] Build account summary widget
  - [ ] Create margin status indicator
  - [ ] Implement instrument spread table
  - [ ] Add balance history chart
  - [ ] Create position counter display
  - [ ] Build equity curve visualization

## Dev Notes

### Architecture Context
The Account Information & Balance Tracking system provides comprehensive visibility into OANDA account status, enabling traders to make informed decisions based on their current capital and risk exposure. This component is critical for risk management and compliance monitoring.

### Previous Story Context
Builds on Story 8.1's authentication and connection management to fetch and display account data. The real-time update system ensures traders always have current information about their account status.

### Technical Implementation Details

#### Account Data Management
```python
class OandaAccountManager:
    def __init__(self, client: OandaClient):
        self.client = client
        self.cache = AccountDataCache()
        self.update_interval = 5  # seconds
        
    async def get_account_summary(self, account_id: str) -> AccountSummary:
        """Fetch comprehensive account summary"""
        response = await self.client.get(f"/v3/accounts/{account_id}/summary")
        
        return AccountSummary(
            balance=Decimal(response['account']['balance']),
            unrealized_pl=Decimal(response['account']['unrealizedPL']),
            realized_pl=Decimal(response['account']['pl']),
            margin_used=Decimal(response['account']['marginUsed']),
            margin_available=Decimal(response['account']['marginAvailable']),
            margin_closeout_percent=Decimal(response['account']['marginCloseoutPercent']),
            open_positions=response['account']['openPositionCount'],
            pending_orders=response['account']['pendingOrderCount']
        )
```

#### Real-Time Update System
```python
class AccountUpdateService:
    def __init__(self, account_manager: OandaAccountManager):
        self.account_manager = account_manager
        self.websocket_publisher = WebSocketPublisher()
        self.is_running = False
        
    async def start_updates(self):
        """Start real-time account updates"""
        self.is_running = True
        
        while self.is_running:
            try:
                # Fetch latest account data
                account_data = await self.account_manager.get_account_summary()
                
                # Detect changes
                if self.has_changes(account_data):
                    # Publish to WebSocket
                    await self.websocket_publisher.publish(
                        'account.update',
                        account_data.to_dict()
                    )
                    
                await asyncio.sleep(5)  # 5-second interval
                
            except Exception as e:
                logger.error(f"Account update failed: {e}")
                await asyncio.sleep(1)  # Retry after 1 second
```

### Integration Points
- **OANDA API**: Direct integration for account data fetching
- **WebSocket Server**: Real-time updates to dashboard
- **TimescaleDB**: Storage for historical balance data
- **Dashboard**: Display components for account information

### Testing Requirements
- Account data fetch accuracy
- Update interval timing verification
- Margin calculation correctness
- Historical data aggregation
- WebSocket update latency

## Testing
- Account summary data accuracy
- Real-time update frequency
- Margin calculation validation
- Instrument spread calculations
- Historical data retrieval
- Dashboard component rendering

## Dev Agent Record

### Agent Model Used
(To be filled by dev agent)

### File List
(To be filled by dev agent)

### Debug Log References
(To be filled by dev agent)

### Completion Notes List
(To be filled by dev agent)

### Change Log
(To be filled by dev agent)